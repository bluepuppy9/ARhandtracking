<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Duck Hunt WebAR</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body {
        margin: 0;
      }
      .example-container {
        overflow: hidden;
        position: absolute;
        width: 100%;
        height: 100%;
      }
      #score {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 2rem;
        color: white;
        background: rgba(0, 0, 0, 0.5);
        padding: 0.5rem 1rem;
        border-radius: 10px;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div id="score">Score: 0</div>

    <div class="example-container">
      <a-scene
        mindar-image="imageTargetSrc: ./targets.mind; autoStart: true; uiLoading: yes; uiScanning: yes; uiError: yes;"
        embedded
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: true"
      >
        <a-assets>
          <a-asset-item id="duckModel" src="./Duck.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false">
          <a-entity
            id="cursor"
            cursor="fuse: true; fuseTimeout: 1500"
            raycaster="objects: .clickable; far: 20; near: 0.1"
            geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.01"
            material="color: white; opacity: 0.8"
            position="0 0 -0.5"
          ></a-entity>
        </a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
          <a-entity
            id="duck"
            gltf-model="#duckModel"
            position="0 0 0.1"
            scale="0.05 0.05 0.05"
            class="clickable"
            geometry="primitive: box; width: 0.4; height: 0.4; depth: 0.4"
            material="transparent: true; opacity: 0.01"
            animation__click="property: scale; startEvents: click; to: 0 0 0; dur: 300; easing: easeOutBack"
            animation__idle="property: rotation; to: 0 360 0; loop: true; dur: 8000"
          ></a-entity>
        </a-entity>
      </a-scene>
    </div>

    <script>
      // Add debugging
      console.log("Script loaded");

      let score = 0;
      let duckVisible = true;
      const scoreDisplay = document.getElementById("score");

      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM Content Loaded");

        const sceneEl = document.querySelector("a-scene");
        if (sceneEl) {
          console.log("Scene found");

          sceneEl.addEventListener("renderstart", function () {
            console.log("Scene render started");
          });

          // Listen for AR events
          sceneEl.addEventListener("arReady", function () {
            console.log("AR Ready");
          });

          sceneEl.addEventListener("arError", function (event) {
            console.log("AR Error:", event.detail);
          });

          // Wait for scene to load before setting up duck events
          sceneEl.addEventListener("loaded", function () {
            setupDuckEvents();
          });
        }
      });

      function setupDuckEvents() {
        const duck = document.querySelector("#duck");
        if (duck) {
          console.log("Duck found, setting up events");

          // Handle multiple event types for better compatibility
          duck.addEventListener("click", function (e) {
            console.log("Duck clicked!");
            shootDuck();
            e.stopPropagation();
          });

          duck.addEventListener("touchstart", function (e) {
            console.log("Duck touched!");
            shootDuck();
            e.preventDefault();
            e.stopPropagation();
          });

          duck.addEventListener("fused", function () {
            console.log("Duck fused!");
            shootDuck();
          });

          duck.addEventListener("mouseenter", function () {
            console.log("Mouse entered duck");
            duck.setAttribute("material", "color: red; opacity: 0.3");
          });

          duck.addEventListener("mouseleave", function () {
            console.log("Mouse left duck");
            duck.setAttribute("material", "transparent: true; opacity: 0.01");
          });
        }

        // Also add click event to the entire scene as fallback
        const scene = document.querySelector("a-scene");
        scene.addEventListener("click", function (e) {
          console.log("Scene clicked at:", e.detail);
          // If click is near center, assume it's meant for the duck
          shootDuck();
        });
      }

      function shootDuck() {
        if (!duckVisible) return;

        console.log("Duck shot!");
        duckVisible = false;
        score++;
        scoreDisplay.textContent = `Score: ${score}`;

        const duck = document.querySelector("#duck");
        duck.setAttribute(
          "animation__click",
          "property: scale; to: 0 0 0; dur: 300; easing: easeOutBack"
        );

        // Respawn duck after 2 seconds
        setTimeout(() => {
          duck.setAttribute("scale", "0.05 0.05 0.05");
          duck.removeAttribute("animation__click");
          duckVisible = true;
          console.log("Duck respawned");
        }, 2000);
      }
    </script>
  </body>
</html>
